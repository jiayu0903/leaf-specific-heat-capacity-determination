2*lamda*0.018*0.92*R*(Twet+273)/(2*Patm)*(es-ea)
2*lamda*0.018*0.92*R*(Twet+273)/(2*Pa)*(es-ea)
2*lamda*0.018*0.92*R*(Twet+273)/(2*Pa)*(es-ea) / Pa
2*lamda*0.018*0.92*R*(Twet+273)/(Pa)*(es-ea) / Pa
2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
2*lamda*0.622/0.92*rho*((es-ea)/Pa)
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*rho*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
0.622/0.92*rho*
0.622/0.92*rho
0.018*Pa/(0.92*R*(Twet+273))
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*rho*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
rho <- Pa / (287.058 * (Tair+273))
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*1*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*1.21*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*1.22*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*1.23*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*1.225*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Twet+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
# Dry&Wet reference temperature and environment data
Twet <- 15.01
Tdry <- 20.73
Tair <- 20.4
RH <- 0.465
# Known parameters
Pa <- 101300
R <- 8.3145
#VPD
ea <- 613.65 * exp(17.502 * Tdry / (240.97 + Tdry)) * RH
es <- 613.65 * exp(17.502 * Twet / (240.97 + Twet))
SH <- 0.622 * ea / (Pa - ea)
Cs <- 1005 + 1820 * SH
rho <- Pa / (287.058 * (Tair+273))
lamda <- 1.91846E6 * ((Twet+273) / (Twet+273 - 33.91))**2
# numerator part of equation
gbl_numerator  <-  2*0.95 * 5.6703E-8 * ((Tdry+273)**4 - (Twet+273)**4)
# denominator part of equation (version#1)
gbl_denominator_1 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.622/0.92*rho*((es-ea)/Pa)
# denominator part of equation (version#2)
gbl_denominator_2 <-2*rho*Cs*(Twet-Tdry)+2*lamda*0.018*Pa/(0.92*R*(Tair+273))*(es-ea) / Pa
# final result
gbl_1 <- gbl_numerator/gbl_denominator_1
gbl_2 <- gbl_numerator/gbl_denominator_2
gbl_1
gbl_2
data1
data1 <-
3832.798714
3751.026795
3788.046986
3609.843064
3615.468149
3640.041605
3382.941489
3188.639474
data1 <- c(3832.798714,3751.026795,3788.046986,3609.843064,3615.468149,3640.041605,,3382.941489
3188.639474)
data1 <- c(3832.798714,3751.026795,3788.046986,3609.843064,3615.468149,3640.041605,3382.941489,
3188.639474)
data2 <- c(3618.784573	3521.372093	3612.063387	3641.587915	3646.182077	3569.039493	3305.947088	3076.830038
data2 <- c(3618.784573,	3521.372093,3612.063387,	3641.587915,	3646.182077,	3569.039493,3305.947088,3076.830038
)
result <- t.test(data1, data2)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
data3 <- (3852.254545,	3756.130233,	3695.655597,	3550.88834,	3518.938659,	3886.18226,	3589.863942,	3395.693985
data3 <- (3852.254545,3756.130233,3695.655597,3550.88834,3518.938659,3886.18226,3589.863942,3395.693985)
data3 <- (3852.254545,3756.130233,3695.655597,3550.88834,3518.938659,3886.18226,3589.863942,3395.693985)
data3 <- c(3852.254545,3756.130233,3695.655597,3550.88834,3518.938659,3886.18226,3589.863942,3395.693985)
data4 <- c(4187.867631,	4092.957128,	4003.626896,	3813.917106,	3874.342688,	3578.506441,	3320.383539,	3143.087481
)
result <- t.test(data2, data3,data4)
result <- t.test(data2, data3)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
result <- t.test(data3, data4)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
result <- t.test(data4, data2)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
result <- t.test(data4, data1)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
data5 <- c(4019.179393,	4027.97557,	3989.225648,	3829.856072,	3831.03894,	3800.572657,	3581.466212,	3528.195092
)
result <- t.test(data5, data1)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
data11 <- c(2828.992411,	2800.542471,	2738.631872	,3364.188245,	3107.418688,	3073.707353,	3302.14944,	3203.249065,	3421.414485
)
data11 <- c(3847.91,
3899.59,
3792.53
4529.11,
data11 <- c(3847.91,
3899.59,
3792.53,
4529.11,
4011.86,
4093.45,
3795.33,
3866.31,
3442.88,
3457.10)
data22 <- c(4399.331485,
4490.745745,
4223.146033,
4631.60396,
4533.617223,
4469.857471,
4419.17372,
4448.049537,
4054.941728,
4009.856278)
result <- t.test(data22, data11)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
data11 <- c(3747.97,
3841.45,
4047.64,
4183.72,
3972.61,
4174.99,
4184.98,
4198.57,
)
data11 <- c(3747.97,
3841.45,
4047.64,
4183.72,
3972.61,
4174.99,
4184.98,
4198.57)
data22 <- c(3886.600677,
3952.710671,
4152.891159,
4364.050811,
4156.857608,
4352.602666,
4464.229035,
4379.487119)
result <- t.test(data4, data1)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
data5 <- c(4019.179393,	4027.97557,	3989.225648,	3829.856072,	3831.03894,	3800.572657,	3581.466212,	3528.195092
)
result <- t.test(data22, data11)
p_value <- result$p.value
if (p_value < 0.05) {
print("差异显著")
} else {
print("差异不显著")
}
setwd("D:/1Rmodel/WP2/0315sugarbeans/first/leaf2")
library(ggplot2)
library(cowplot)
library(cmdstanr)
library(posterior)
library(bayesplot)
library(readxl)
color_scheme_set("brightblue")
theme_set(theme_cowplot())
###
#
# Warning: this model is only for a transpiring leaf !
#
###
# Directory of the data
dr <- "./sugarbeans-0315-leaf2/"
date <- "2023-03-15"
time <- "19:59:00"
# Start time of the temperature records
t0 <- as.POSIXct(paste(date, time), format="%Y-%m-%d %H:%M:%OS")
# Time points when the light was switched on
tON <- c("19:59:00")
# Observed vs. estimated light intensity (same units)
PAR <- c(257.9754468)
# Read and process air temperature data
dA <- read.csv(paste0(dr, "AirT.csv"))
dA$time <- as.POSIXct(paste(date, dA$Time), format="%Y-%m-%d %I:%M:%OS %p")
ggplot(dA, aes(x=time, y=Temperature)) + geom_point()
ggplot(dA, aes(x=time, y=Humidity)) + geom_point()
# Read and process leaf temperature data
dL <- read.csv(paste0(dr, "LeafT.csv"))
names(dL) <- c("Date", "Time", "Temperature", "Tair","Treflect")
# Parse date string
dL$ts <- as.POSIXct(paste(date, dL$Date), format="%Y-%m-%d %I:%M:%OS %p")
ggplot(dL, aes(x=ts, y=Temperature)) + geom_point()
ggplot(dL, aes(x=ts, y=Tair)) + geom_point()
# Find initial time common to both data sets
dA$time <- as.numeric(dA$time - t0)
dL$time <- dL$Time + as.numeric(dL$ts[1] - t0)
dA <- subset(dA, time >= 0)
dL <- subset(dL, time >= 0)
# Use splines to extract data at common time points
spl_A <- splinefun(dA$time, dA$Temperature)
spl_R <- splinefun(dA$time, dA$Humidity)
spl_L <- splinefun(dL$time, dL$Temperature)
spl_A2 <- splinefun(dL$time, dL$Tair)
spl_E <- splinefun(dL$time, dL$Treflect)
fitt <- smooth.spline(dA$time, dA$Humidity, cv=TRUE)
fitt2 <- smooth.spline(dA$time, dA$Temperature, cv=TRUE)
fitt3 <- smooth.spline(dL$time, dL$Tair, cv=TRUE)
fitt4 <- smooth.spline(dL$time, dL$Treflect, cv=TRUE)
fitt$df
fitt2$df
fitt3$df
fitt4$df
# Remove high frequency fluctuations
sspl_R <- smooth.spline(dA$time, dA$Humidity, df=22)
sspl_A <- smooth.spline(dA$time, dA$Temperature, df=2)
sspl_A2 <- smooth.spline(dL$time, dL$Tair, df=143)
sspl_E <- smooth.spline(dL$time, dL$Treflect, df=129)
# Check spline function
plot(Humidity~time, dA, pch=16)
points(predict(sspl_R, time)$y~time, dA, lty=2, lwd=2, col="red")
plot(Temperature~time, dA, pch=16)
lines(predict(sspl_A, time)$y~time, dA, lty=2, lwd=2, col="red")
plot(Tair~time, dL, pch=16)
lines(predict(sspl_A2, time)$y~time, dL, lty=2, lwd=2, col="red")
# New time points
time <- subset(dL, time < max(dA$time))$time
# Merge the data sets
d <- data.frame(time=time, Ta=predict(sspl_A, time)$y,
Ta2=predict(sspl_A2, time)$y,
Treflect=predict(sspl_E, time)$y,
Tl=spl_L(time),
RH=predict(sspl_R, time)$y)
# Correct for offset between Rotronic sensor and thermal camera temperature
#d$Tl <- d$Tl - (tail(d$Tl) - tail(d$Ta))
ggplot(d, aes(x=time)) + geom_point(aes(y=Ta)) +
geom_point(aes(y=Ta2), col="blue") +
geom_point(aes(y=Tl), col="red") + geom_point(aes(y=Treflect), col="green") +ylab("Temperature")
ggplot(d, aes(x=time, y=Tl - Ta)) + geom_point() + ylab("Tl - Ta")
# Function to be passed to the ODE solver
l <- NULL
l$N1 <- nrow(d)
# Time light was turned ON
l$tON <- paste(date, tON)
l$tON <- as.POSIXct(l$tON, format="%Y-%m-%d %H:%M:%OS")
l$tON <- as.numeric(l$tON - t0, units="secs")
l$N2 <- length(l$tON)
l$Qabs <- PAR
l$ts <- diff(c(0, l$tON, max(d$time)))
l$N3 <- length(l$ts)
l$dt <- rep(10, length(l$tON))
l$N4 <- length(l$dt)
l$Tair <- d$Ta
l$RH <- d$RH / 100
l$Treflect <- d$Treflect
l$Tleaf <- d$Tl
l$time <- d$time
l$step <- 0.1
l$tmax <- max(d$time)
###
# Generate initial parameter values
##
init <- function()
{
list(gbl=runif(1,0.01,0.03),
gsw=runif(1,0.001,0.003),
k=runif(1,600,900),
sT=runif(1,0.2,0.3))
}
# Compile the bayesian model
file <- file.path(getwd(), "model.stan")
header <- file.path(getwd(), "user_header.hpp")
mod <- cmdstan_model(file,
cpp_options=list(USER_HEADER=header),
stanc_options = list("allow-undefined"))
# Fit the model to observed data
fit <- mod$sample(
data = l,
chains = 4,
parallel_chains = 4,
refresh = 10,
init=init,
iter_warmup = 500,
iter_sampling = 500,
adapt_delta=0.7,
save_warmup = T,
output_dir=getwd(),
metric = "dense_e",
step_size=0.0001
)
# See if the model converged properly
fit$cmdstan_diagnose()
fit$save_object(file = "fit.RDS")
fit <- readRDS("fit.RDS")
# Diagnostic graphs
np <- names(init())
fs <- fit$summary(np)
mcmc_hist(fit$draws(np))
mcmc_trace(fit$draws(np), n_warmup=500)
mcmc_pairs(fit$draws(np))
fs
png("Kin.png", width=1280, height=960, res=200)
par(mar=c(5,5,2,2))
mod <- matrix(matrix(fit$draws("mod")[,1,], nrow=500)[500,], ncol=1)
Tl_mod <- mod[,1]
plot(Tl~time, d, pch=16,
xlab="Time (s)",
ylab=expression("T ("*degree*"C)"))
points(Tl_mod~time, d, type="l", col="red", lty=2, lwd=2)
dev.off()
